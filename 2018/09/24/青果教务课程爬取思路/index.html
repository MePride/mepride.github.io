<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="咸鱼的开发日誌"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>青果教务课程爬取思路 - Pride's</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="https://i.loli.net/2018/09/04/5b8e619c41726.png"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/MePride"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://i.loli.net/2018/09/04/5b8e64ca934c8.jpg"><div class="post-title"><h1 class="title">青果教务课程爬取思路</h1><ul class="meta"><li><i class="icon icon-author"></i>Pride</li><li><i class="icon icon-clock"></i>36 Minutes</li><li><i class="icon icon-calendar"></i>2018年9月24日</li></ul></div></div><div class="article-content" style="max-width:800px"><p>其实在去年写过一个Android小程序，一个关于课表的程序，不过由于技术水平有限，自绘的课程布局丑陋不堪…以及软件的并发效率问题，目前已经被我停更。233333….说起来自己做课表app也是迫于无奈，从上篇可以看出教务系统在登陆上进行多次md5加密，登陆后的课程信息，全都是处理过的表格图片，当然我不知道这么做的意义，杜绝了第三方课表倒是真的。不过青果自家的教务APP(喜鹊儿)也很不走心，选课后大概是这个样子，只显示一个体育课…?????</p>
<p><img src="https://i.loli.net/2018/09/24/5ba7cb111ba6c.png" alt="TIM截图20180924002958"></p>
<p><img src="https://i.loli.net/2018/09/24/5ba7cb10d3bce.jpg" alt="GoHome"></p>
<p>话已至此，接下来开始正题，去年的一开始我是打算用百度的OCR识别引擎，当然，识别的效率十分感人，一开始我就没用过，何况还得分栏。后在好友@Crab的帮助下找到这么个页面http://·····/ZNPK/KBFB_DayJCSel.aspx(学校相关网址信息已隐藏)。</p>
<p><img src="https://i.loli.net/2018/09/24/5ba84d5aa3294.jpg" alt="TIM截图20180924004021"></p>
<p>为止惊喜的是这个页面的验证码和cookies可以被重复调用，这也就意味着我能够一周周去爬取课程内容，在用户只输入一次验证码的情况下。</p>
<h3 id="实现思路："><a href="#实现思路：" class="headerlink" title="实现思路："></a>实现思路：</h3><p><a href="https://i.loli.net/2018/09/24/5ba852dbac26e.png" target="_blank" rel="noopener"><img src="https://i.loli.net/2018/09/24/5ba852dbac26e.png" alt="ED618196-9F09-4228-9FCB-241318ADD403.png"></a></p>
<h3 id="接下来就是整个程序的实现过程了。"><a href="#接下来就是整个程序的实现过程了。" class="headerlink" title="接下来就是整个程序的实现过程了。"></a>接下来就是整个程序的实现过程了。</h3><h4 id="F12了解一下"><a href="#F12了解一下" class="headerlink" title="F12了解一下"></a>F12了解一下<img src="https://i.loli.net/2018/09/24/5ba84d5944efa.jpg" alt="TIM截图20180924005313"></h4><p>请求课程数据是一次POST请求，关于POST上篇文提到过，这里不再提。</p>
<h4 id="请求部分主要包括："><a href="#请求部分主要包括：" class="headerlink" title="请求部分主要包括："></a>请求部分主要包括：</h4><table>
<thead>
<tr>
<th>Sel_XNXQ</th>
<th>学年学期</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sel_ZC</td>
<td>周次</td>
</tr>
<tr>
<td>Sel_XQ</td>
<td>学期</td>
</tr>
<tr>
<td>Sel_XZBJ</td>
<td>行政班级</td>
</tr>
<tr>
<td>rad</td>
<td>周</td>
</tr>
</tbody>
</table>
<p><img src="https://i.loli.net/2018/09/24/5ba7cb10a8d83.png" alt="TIM截图20180924005602"></p>
<h4 id="返回数据中可以清楚看到课程信息，正常排列如下："><a href="#返回数据中可以清楚看到课程信息，正常排列如下：" class="headerlink" title="返回数据中可以清楚看到课程信息，正常排列如下："></a>返回数据中可以清楚看到课程信息，正常排列如下：</h4><p><img src="https://i.loli.net/2018/09/24/5ba7cb110a4c3.png" alt="TIM截图20180924004511"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"5%"</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span>3</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"22%"</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span>[16ZH142413]化工热力学</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"10%"</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span>001</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"5%"</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>65</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"10%"</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span>吴*</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"12%"</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span>二[1-2节]</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"16%"</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span>东教A116</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"20%"</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span>16化工1</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="以上是单节课程的代码，可以注意到的是所需信息所属表格的width都是有着不同的百分比，结果一目了然了。"><a href="#以上是单节课程的代码，可以注意到的是所需信息所属表格的width都是有着不同的百分比，结果一目了然了。" class="headerlink" title="以上是单节课程的代码，可以注意到的是所需信息所属表格的width都是有着不同的百分比，结果一目了然了。"></a>以上是单节课程的代码，可以注意到的是所需信息所属表格的width都是有着不同的百分比，结果一目了然了。</h4><p>而包含课程信息的代码又是最内部的<tbody>为爬取带来了一定的方便，剩下的就是将课表进行序列化。</tbody></p>
<h4 id="Schedule类部分-这里调用了zfman的TimetableView所以该类按照其代码标准进行编写"><a href="#Schedule类部分-这里调用了zfman的TimetableView所以该类按照其代码标准进行编写" class="headerlink" title="Schedule类部分(这里调用了zfman的TimetableView所以该类按照其代码标准进行编写):"></a>Schedule类部分(这里调用了<a href="https://github.com/zfman" target="_blank" rel="noopener">zfman</a>的<a href="https://github.com/zfman/TimetableView" target="_blank" rel="noopener"><strong>TimetableView</strong></a>所以该类按照其代码标准进行编写):</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySubject</span> <span class="keyword">implements</span> <span class="title">ScheduleEnable</span>,<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRAS_ID=<span class="string">"extras_id"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**课程名*/</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//无用数据</span></span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line">    <span class="comment">/**教室*/</span></span><br><span class="line">    <span class="keyword">private</span> String room;</span><br><span class="line">    <span class="comment">/** 教师*/</span></span><br><span class="line">    <span class="keyword">private</span> String teacher;</span><br><span class="line">    <span class="comment">/**第几周至第几周上*/</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; weekList;</span><br><span class="line">    <span class="comment">/**开始上课的节次*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">    <span class="comment">/**上课节数*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> step;</span><br><span class="line">    <span class="comment">/**周几上*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> day;</span><br><span class="line">    <span class="keyword">private</span> String term;</span><br><span class="line">    <span class="comment">/**一个随机数，用于对应课程的颜色*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> colorRandom = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;MySubject&gt; mySubjects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">/**从网络获取课程 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;MySubject&gt; <span class="title">getCourse</span><span class="params">(<span class="keyword">final</span> String code, <span class="keyword">final</span> String session, <span class="keyword">final</span> String year, <span class="keyword">final</span> String classNum, <span class="keyword">final</span> Context context)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;MySubject&gt; mySubjectList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        mySubjectList.clear();</span><br><span class="line">        ExecutorService ThreadPool = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= <span class="number">10</span>;i++) &#123;</span><br><span class="line">                        RequestBody body = <span class="keyword">new</span> FormBody.Builder()</span><br><span class="line">                                .add(<span class="string">"rad"</span>, <span class="string">"1"</span>)</span><br><span class="line">                                .add(<span class="string">"sel_bm"</span>, <span class="string">"Nothing"</span>)</span><br><span class="line">                                .add(<span class="string">"sel_cddw"</span>, <span class="string">""</span>)</span><br><span class="line">                                .add(<span class="string">"Sel_JS"</span>, <span class="string">""</span>)</span><br><span class="line">                                .add(<span class="string">"Sel_KC"</span>, <span class="string">""</span>)</span><br><span class="line">                                .add(<span class="string">"Sel_XNXQ"</span>, year)</span><br><span class="line">                                .add(<span class="string">"Sel_XQ"</span>, <span class="string">""</span>)</span><br><span class="line">                                .add(<span class="string">"Sel_XZBJ"</span>, classNum)</span><br><span class="line">                                .add(<span class="string">"sel_yx"</span>, <span class="string">"Nothing"</span>)</span><br><span class="line">                                .add(<span class="string">"sel_ZC"</span>, Integer.toString(i))</span><br><span class="line">                                .add(<span class="string">"txt_yzm"</span>, code)</span><br><span class="line">                                .build();</span><br><span class="line">                        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                                .url(<span class="string">"http://address/ZNPK/KBFB_DayJCSel_rpt.aspx"</span>)</span><br><span class="line">                                .addHeader(<span class="string">"Host"</span>, adress)</span><br><span class="line">                                .addHeader(<span class="string">"User-Agent"</span>, <span class="string">""</span>)</span><br><span class="line">                                .addHeader(<span class="string">"Referer"</span>, <span class="string">"http://address/ZNPK/KBFB_DayJCSel.aspx"</span>)</span><br><span class="line">                                .addHeader(<span class="string">"Cookie"</span>, session)</span><br><span class="line">                                .post(body)</span><br><span class="line">                                .build();</span><br><span class="line">                        Response response = okHttpClient.newCall(request).execute();</span><br><span class="line">                        Document document = Jsoup.parse(response.body().string().replaceAll(<span class="string">"序列化后的第一行标题"</span>,<span class="string">""</span>));</span><br><span class="line">                        Element table = document.getElementsByTag(<span class="string">"TABLE"</span>).last();</span><br><span class="line">                        tbody = Jsoup.parse(table.toString().replaceAll(<span class="string">"&lt;td width=\"10%\" align=\"center\"&gt;"</span>,<span class="string">""</span>)).getElementsByTag(<span class="string">"tbody"</span>);</span><br><span class="line">                        <span class="keyword">for</span> (Element element:tbody)&#123;</span><br><span class="line">                            Elements tr = element.getElementsByTag(<span class="string">"tr"</span>);</span><br><span class="line">                            <span class="keyword">for</span> (Element element1:tr)&#123;</span><br><span class="line">                                <span class="keyword">if</span> (!<span class="string">""</span>.equals(element1.getElementsByAttributeValue(<span class="string">"width"</span>,<span class="string">"'22%'"</span>).text()))&#123;</span><br><span class="line">                                    className = element1.getElementsByAttributeValue(<span class="string">"width"</span>,<span class="string">"'22%'"</span>).text();</span><br><span class="line">                                    className = className.substring(<span class="number">12</span>,className.length());</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (!<span class="string">""</span>.equals(element1.getElementsByAttributeValue(<span class="string">"width"</span>,<span class="string">"\'16%\'"</span>).text()))&#123;</span><br><span class="line">                                    classRoom = element1.getElementsByAttributeValue(<span class="string">"width"</span>,<span class="string">"\'16%\'"</span>).text();</span><br><span class="line">                                &#125;</span><br><span class="line">                                String weeks = element1.getElementsByAttributeValue(<span class="string">"width"</span>, <span class="string">"\'12%\'"</span>).text();</span><br><span class="line">                                String teacher = element1.getElementsByAttributeValue(<span class="string">"width"</span>,<span class="string">"'10%'"</span>).text();</span><br><span class="line">                                <span class="keyword">int</span> weekNum = transformWeek(weeks);</span><br><span class="line">                                <span class="keyword">int</span> start = Integer.parseInt(weeks.subSequence(<span class="number">2</span>,<span class="number">3</span>).toString());</span><br><span class="line">                                <span class="keyword">int</span> end = Integer.parseInt(weeks.substring(weeks.indexOf(<span class="string">"-"</span>)+<span class="number">1</span>,weeks.indexOf(<span class="string">"节"</span>)).toString());</span><br><span class="line">                                List&lt;Integer&gt; weekList = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(i));</span><br><span class="line">                                mySubjects.add(<span class="keyword">new</span> MySubject(<span class="string">"2018-2019学年春"</span>, className, classRoom, teacher, weekList, start, end - start + <span class="number">1</span>, weekNum, <span class="number">1</span>, <span class="string">""</span>));</span><br><span class="line">                                <span class="keyword">if</span> (i==<span class="number">9</span>)&#123;</span><br><span class="line">                                    List&lt;Integer&gt; singleWeek = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="number">11</span>,<span class="number">13</span>,<span class="number">15</span>,<span class="number">17</span>));</span><br><span class="line">                                    <span class="comment">//单周</span></span><br><span class="line">                                    mySubjects.add(<span class="keyword">new</span> MySubject(<span class="string">"2018-2019学年春"</span>, className, classRoom, teacher, singleWeek, start, end - start + <span class="number">1</span>, weekNum, <span class="number">1</span>, <span class="string">""</span>));</span><br><span class="line">                                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (i==<span class="number">10</span>)&#123;</span><br><span class="line">                                    List&lt;Integer&gt; doubleWeek = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="number">12</span>,<span class="number">14</span>,<span class="number">16</span>,<span class="number">18</span>));</span><br><span class="line">                                    <span class="comment">//单周</span></span><br><span class="line">                                    mySubjects.add(<span class="keyword">new</span> MySubject(<span class="string">"2018-2019学年春"</span>, className, classRoom, teacher, doubleWeek, start, end - start + <span class="number">1</span>, weekNum, <span class="number">1</span>, <span class="string">""</span>));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            handleData(mySubjects);</span><br><span class="line">                            SheduleDao.saveCourse(getContext(),<span class="string">"course"</span>,mySubjects);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        ThreadPool.execute(runnable);</span><br><span class="line">        <span class="keyword">return</span> mySubjectList;</span><br><span class="line">    &#125;</span><br><span class="line"> 	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对捕获的星期数据进行遍历替换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> weeks</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">transformWeek</span><span class="params">(String weeks)</span></span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (weeks.subSequence(<span class="number">0</span>,<span class="number">1</span>).toString())&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"一"</span>:week = <span class="number">1</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"二"</span>:week = <span class="number">2</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"三"</span>:week = <span class="number">3</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"四"</span>:week = <span class="number">4</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"五"</span>:week = <span class="number">5</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"六"</span>:week = <span class="number">6</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"日"</span>:week = <span class="number">7</span>;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> week;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程合并</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleData</span><span class="params">(List&lt;MySubject&gt; list)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(list==<span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        Map&lt;String,List&lt;Integer&gt;&gt; map=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        List&lt;MySubject&gt; delete=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(MySubject item:list)&#123;</span><br><span class="line">            <span class="comment">//保证键的唯一性</span></span><br><span class="line">            String key=item.getName()+<span class="string">"#"</span>+item.getRoom()+<span class="string">"#"</span></span><br><span class="line">                    +<span class="string">"#"</span>+item.getTerm()+<span class="string">"#"</span>+item.getDay()+<span class="string">"#"</span></span><br><span class="line">                    +item.getStart()+<span class="string">"#"</span>+item.getStep();</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(key))&#123;</span><br><span class="line">                map.get(key).addAll(item.getWeekList());</span><br><span class="line">                delete.add(item);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                map.put(key,item.getWeekList());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        list.removeAll(delete);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>遍历思路：</p>
<p>1.先对返回内容取最后一层<table>后进而取出<tbody></tbody></table></p>
<p>2.对<tbody>进行一次forech循环遍历<tr>得到单节课程信息</tr></tbody></p>
<p>3.对<tr>进行最后一次遍历得到对应课程的所有信息。</tr></p>
<p>这里使用全局变量记录所有的信息，由于课程排列如此故遍历时临时建立变量会导致空列表。</p>
<p><img src="https://i.loli.net/2018/09/24/5ba84e9707b83.png" alt="TIM截图20180924005313"></p>
<p>此处判断此层是否存在新内容，若存在则替换，若不存在，不变。</p>
<p>==<em>4.由于cookies只能在短时间内使用十次，所以更改遍历规则为从第一周到第十周(原第一周和第二周)，由于个别班级学期中途课程会变化，故作此改变，再将9、10两周的课程复制四次覆盖到11-18周，最后通过<a href="https://github.com/zfman/TimetableView" target="_blank" rel="noopener"><strong>TimetableView</strong></a>中issue的解决方法来进行课程合并。</em>==</p>
<p>5.发现了一个因为课程数为十位数产生的bug，将end值获取方法改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> end = Integer.parseInt(weeks.substring(weeks.indexOf(<span class="string">"-"</span>)+<span class="number">1</span>,weeks.indexOf(<span class="string">"节"</span>)).toString());</span><br></pre></td></tr></table></figure>
<p>以获取‘-’与‘节’之间的数字部分解决此bug。</p>
<p>代码部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String weeks = element1.getElementsByAttributeValue(<span class="string">"width"</span>, <span class="string">"\'12%\'"</span>).text();</span><br><span class="line">                               String teacher = element1.getElementsByAttributeValue(<span class="string">"width"</span>,<span class="string">"'10%'"</span>).text();</span><br><span class="line">                               <span class="keyword">int</span> weekNum = transformWeek(weeks);</span><br><span class="line">                               <span class="keyword">int</span> start = Integer.parseInt(weeks.subSequence(<span class="number">2</span>,<span class="number">3</span>).toString());</span><br><span class="line">                               <span class="keyword">int</span> end = Integer.parseInt(weeks.subSequence(<span class="number">4</span>,<span class="number">5</span>).toString());</span><br></pre></td></tr></table></figure>
<h4 id="如上操作后最后得到的List-mySubjects便是符合zfman的TimetableView的课程格式，后转为json格式通过SharedPreferences进行储存于本地。"><a href="#如上操作后最后得到的List-mySubjects便是符合zfman的TimetableView的课程格式，后转为json格式通过SharedPreferences进行储存于本地。" class="headerlink" title="如上操作后最后得到的List mySubjects便是符合zfman的TimetableView的课程格式，后转为json格式通过SharedPreferences进行储存于本地。"></a>如上操作后最后得到的List<mysubject> mySubjects便是符合<a href="https://github.com/zfman" target="_blank" rel="noopener">zfman</a>的<a href="https://github.com/zfman/TimetableView" target="_blank" rel="noopener"><strong>TimetableView</strong></a>的课程格式，后转为json格式通过SharedPreferences进行储存于本地。</mysubject></h4><h3 id="最终的结果："><a href="#最终的结果：" class="headerlink" title="最终的结果："></a>最终的结果：<img src="https://i.loli.net/2018/09/24/5ba7cb113ad23.png" alt="EA24E84C0D8E623D39E8A2EE16A70F61"></h3><p>本文后续相关内容会相继补充*</p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">4</span></li></ul></div></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="cjs90y7lz000f48wneaos27g8" data-title="青果教务课程爬取思路" data-url="http://yoursite.com/2018/09/24/青果教务课程爬取思路/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2018/10/02/MVP架构从蒙蔽到自闭/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2018/09/02/基于okhttp模拟登陆青果教务系统/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/MePride" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://segmentfault.com/u/pride" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li><li><a href="8425284@qq.com" title="Email" target="_blank"><i class="icon icon-email"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2019 Pride's<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>